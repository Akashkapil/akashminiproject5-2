#include<stdio.h>
#include<conio.h>
#include<string.h>

int main()
{
    char label[20],opcode[20],operand[20],symbol[20],a[20],addr[20],ch;
    int address,final_address,previous_address,st,length,actual_length,j=0,i,choice;
    char mneumonic[20][20]={"LOD","STD","LODC","STRC"};
    char code[20][20]={"30","40","50","55"};

    FILE *fp1,*fp2,*fp3,*fp4;

    fp1=fopen("INTERMED.DAT","r");
    fp2=fopen("OBJCODE.DAT","w");
    fp3=fopen("ASSMLIST","w");
    fp4=fopen("SYMTAB","r");
//WE ARE USING .DAT FORMAT BECAUSE IN .TXT FORMAT THE STRING WILL READ ONLY ONE CHAR AT A TIME SO AS TO READ THE WHOLE STRING WE ARE USING THE .DAT FORMAT
    fscanf(fp1,"%s%s%s",label,opcode,operand);
    while(strcmp(opcode,"END")!=0)
    {
        previous_address=address;
        fscanf(fp1,"%d%s%s%s",&address,label,opcode,operand);
    }
    final_address=address;
    fclose(fp1);
    fp1=fopen("INTERMED.DAT","r");

    fscanf(fp1,"%s%s%s",label,opcode,operand);
    if(strcmp(opcode,"START")==0)
    {
       fprintf(fp3,"\t%s\t%s\t%s\n",label,opcode,operand);
       fprintf(fp2,"H^%s^00%s^00%d\n",label,operand,final_address);
       fscanf(fp1,"%d%s%s%s",&address,label,opcode,operand);
       st=address;
       diff=previous_address-st;
       fprintf(fp2,"T^00%d^%d",address,diff);
    }
    do
    {
       if(strcmp(opcode,"WORD")==0)
       {
        length=strlen(operand);
        itoa(atoi(operand),a,10);
        fprintf(fp3,"%d\t%s\t%s\t%s\t00000%s\n",address,label,opcode,operand,a);
        fprintf(fp2,"^00000%s",a);
       }
       else if(strcmp(opcode,"BYTE")==0)
       {
        fprintf(fp3,"%d\t%s\t%s\t%s\t",address,label,opcode,operand);
        length=strlen(operand);
        actual_length=length-3;
        fprintf(fp2,"^");
        for(i=2;i<(actual_length+2);i++)
        {
            itoa(operand[i],addr,16);           //itoa function converts integer to string
            fprintf(fp3,"%s",addr);             //atoi function convert string to integer
            fprintf(fp2,"%s",addr);
        }
        fprintf(fp3,"\n");
       }
       else if((strcmp(opcode,"RESB")==0)||(strcmp(opcode,"RESW")==0))
       {
           fprintf(fp1,"%d\t%s\t%s\t%s\n",address,label,opcode,operand);
       }
       else
       {
           while(strcmp(opcode,mnemonic[j])!=0)
            j++;
            if(strcmp(operand,"COPY")==0)
            fprintf(fp3,"%d\t%s\t%s\t%s\t%s0000\n",address,label,opcode,operand,code[j]);
            else
            {
             rewind(fp4);   //it sets the file position indicator to the begining of the file
             fscanf(fp4,"%s%d",symbol,&addr2);
              while(strcmp(operand,symbol)!=0)
              {
               fscanf(fp4,"%s%d",symbol,&addr2);
              }
             fprintf(fp3,"%d\t%s\t%s\t%s\t%s%d\n",address,label,opcode,operand,code[j],addr2);
             fprintf(fp2,"^%s%d",code[j],addr2);
            }
       }
       fscanf(fp1,"%d%s%s%s",&address,label,opcode,operand);
    }while(strcmp(opcode,"END")!=0);
    system("color 2");
    fprintf(fp3,"%d\t%s\t%s\t%s\n",address,label,opcode,operand);
    fprintf(fp2,"\nE^00%d",st);

    fclose(fp2);
    fclose(fp1);
    printf("\n\n******************************WELCOME***********************************\n\n");
do
{
  printf("\n\n1)Press 1 to display intermediate file \n2)Press 2 to display the symbol table\n3)Press 3 to display the contents of object file\n4)Press4 to exit\n");
  scanf("\n%d",&choice);
    switch(choice)
      {
       case 1:
          printf("\n\nThe contents of Intermediate file:\n\n");
          fp1=fopen("INTERMED.DAT","r");
          ch=fgetc(fp1);
          while(ch!=EOF)
          {
           printf("%c",ch);
           ch=fgetc(fp1);
          }
          fclose(fp1);
          break;
       case 2:
           printf("\n\nThe contents of Symbol Table :\n\n");
           fp4=fopen("SYMTAB.DAT","r");
           ch=fgetc(fp4);
           while(ch!=EOF)
           {
            printf("%c",ch);
            ch=fgetc(fp4);
           }
           fclose(fp4);
           break;
       case 3:
         printf("\n\nThe contents of Object code file :\n\n");
         fp2=fopen("OBJCODE.DAT","r");
         ch=fgetc(fp2);
         while(ch!=EOF)
         {
          printf("%c",ch);
          ch=fgetc(fp2);
         }
         break;
       case 4:
        exit(0);
      }

  }while(choice<4);

  getch();

}
